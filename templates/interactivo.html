<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">

  <!-- ============================================================
       CONFIGURACIÃ“N BÃSICA Y ESTILOS
       ============================================================ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Social</title>
  <link rel="stylesheet" href="/static/main.css">

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Trade+Winds&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lugrasimo&display=swap" rel="stylesheet">
</head>

<body>

  <!-- ============================================================
       LOGO FIJO SUPERIOR IZQUIERDA
       ============================================================ -->
  <a href="/" class="logo-pz">
    <img src="/static/logo.png" alt="Logo PZVERSE">
  </a>

  <!-- ============================================================
       BANNER PRINCIPAL + MENÃš SUPERPUESTO
       ============================================================ -->
  <section class="banner-titulo">
    <div class="banner-contenedor">
      <img src="/static/Social.png" alt="Banner Social">

      <nav class="menu-superpuesto">
        <a href="/" class="btn">Inicio</a>
        <a href="/twitch-mio" class="btn">Patz Oficial</a>
        <a href="/twitch-pareja" class="btn">Zhoomm Oficial</a>
        <a href="/youtube" class="btn">YouTube</a>
        <a href="/blog" class="btn">Blog</a>
        <a href="/interactivo" class="btn">Social</a>
      </nav>
    </div>
  </section>

  <!-- ============================================================
       BLOQUE SUPERIOR â€” RRSS + DISCORD + BOTONES DE SCROLL
       ============================================================ -->
  <div class="bloque-social-superior">

    <!-- BotÃ³n RRSS -->
    <a href="https://doras.to/patz" target="_blank" class="btn-rrss">
      <img src="/static/rrss.png" alt="Redes Sociales">
    </a>

    <!-- BotÃ³n Discord -->
    <a href="https://discord.gg/9UnMmjtmFU" target="_blank" class="btn-discord">
      Ãšnete a mi Discord
    </a>

    <!-- BotÃ³n scroll al chat -->
    <a href="#chat-en-vivo" class="btn-scroll">Ir al Chat</a>

    <!-- BotÃ³n scroll al foro -->
    <a href="#foro" class="btn-scroll">Ir al Foro</a>

  </div>

  <!-- ============================================================
       CHAT EN VIVO
       ============================================================ -->
  <h2 class="titulo-chat">Chat en Vivo</h2>

  <div class="chat-container">

    <!-- Contenedor del chat (para scroll automÃ¡tico) -->
    <section id="chat-en-vivo"></section>

    <!-- Lista de usuarios conectados -->
    <div class="usuarios-conectados" id="usuarios">
      <h3>Conectados</h3>
      <ul id="lista-usuarios"></ul>
    </div>

    <!-- Ãrea del chat -->
    <div class="chat-area">
      <div id="chat-box"></div>

      <div class="chat-input">
        <input type="text" id="mensaje" placeholder="Escribe un mensaje...">
        <button onclick="enviarMensaje()">ENVIAR</button>
      </div>
    </div>
  </div>


  <hr class="separador-chat-foro">


  <!-- ============================================================
     SECCIÃ“N DEL FORO â€” TÃ­tulo + BotÃ³n + Grid
     ============================================================ -->
  <section id="foro" class="foro-section">
    <div class="foro-header">
      <h2>FORO</h2>
      <a href="/nuevo-tema" class="btn-nueva-entrada">+ Nueva entrada</a>
    </div>

    <div class="foro-grid">
      {% for tema in temas %}
      <div class="tarjeta-tema">

        <!-- IMAGEN DEL TEMA (SI EXISTE) -->
        {% if tema.imagen %}
          <img src="{{ tema.imagen }}" alt="Imagen del tema">
        {% endif %}

        <!-- TÃTULO DEL TEMA -->
        <h3>{{ tema.titulo }}</h3>

        <!-- VISTA PREVIA DEL CONTENIDO (HTML SEGURO) -->
        <div class="preview-tema">
          {{ tema.contenido[:300] | safe }}
        </div>

        <!-- BOTÃ“N PARA VER EL TEMA COMPLETO -->
        <a href="/tema/{{ tema.id }}" class="btn-ver-tema">Ver tema</a>

      </div>
      {% endfor %}
    </div>

  </section>


  <!-- ============================================================
       SCRIPTS DEL CHAT (REST API)
       ============================================================ -->
<script>

  /* ------------------------------------------------------------
     REEMPLAZO AUTOMÃTICO DE EMOJIS
     ------------------------------------------------------------ */
  function reemplazarEmojis(texto) {
    return texto
      .replace(/\bhola\b/gi, "ðŸ‘‹")
      .replace(/\bgracias\b/gi, "ðŸ™")
      .replace(/\bfeliz\b/gi, "ðŸ˜Š")
      .replace(/\btriste\b/gi, "ðŸ˜¢")
      .replace(/\bmuerto\b/gi, "ðŸ’€")
      .replace(/\bmiedo\b/gi, "ðŸ˜±")
      .replace(/\bbravo\b/gi, "ðŸ”¥")
      .replace(/\bcorazon\b/gi, "â¤ï¸")
      .replace(/\bamor\b/gi, "ðŸ’–");
  }


  /* ------------------------------------------------------------
     ENVIAR MENSAJE
     ------------------------------------------------------------ */
  function enviarMensaje() {
    let mensaje = document.getElementById("mensaje").value;

    // Reemplazar palabras por emojis
    mensaje = reemplazarEmojis(mensaje);

    fetch("/enviar_mensaje", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ mensaje })
    }).then(() => {
      document.getElementById("mensaje").value = "";
      cargarMensajes();
    });
  }


  /* ------------------------------------------------------------
     CARGAR MENSAJES
     ------------------------------------------------------------ */
  function cargarMensajes() {
    fetch("/mensajes")
      .then(r => r.json())
      .then(data => {
        let html = "";
        data.forEach(m => {
          html += `<p><strong>${m.usuario}</strong>: ${m.texto}</p>`;
        });
        document.getElementById("chat-box").innerHTML = html;

        // Auto-scroll al final
        const box = document.getElementById("chat-box");
        box.scrollTop = box.scrollHeight;
      });
  }

document.getElementById("mensaje").addEventListener("keypress", function(e) {
  if (e.key === "Enter") enviarMensaje();
});


  /* ------------------------------------------------------------
     AUTO-REFRESH CADA 3 SEGUNDOS
     ------------------------------------------------------------ */
  setInterval(cargarMensajes, 3000);

</script>


  <!-- ============================================================
       SOCKET.IO â€” USUARIOS EN TIEMPO REAL
       ============================================================ -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const usuario = "{{ session['user']['name'] if session.get('user') else 'AnÃ³nimo' }}";
    const socket = io({ query: { usuario } });

    socket.on("lista_usuarios", data => {
      const lista = document.getElementById("lista-usuarios");
      lista.innerHTML = "";
      data.forEach(u => lista.innerHTML += `<li>${u}</li>`);
    });
  </script>

  <!-- ============================================================
     FIREBASE MESSAGING â€” NOTIFICACIONES PUSH
     ============================================================ -->

<script type="module">
  /* ============================================================
     IMPORTS DE FIREBASE
     ESTO CARGA LAS LIBRERÃAS NECESARIAS PARA NOTIFICACIONES PUSH
     ============================================================ */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging.js";

  /* ============================================================
     CONFIGURACIÃ“N DE FIREBASE
     ESTAS VARIABLES VIENEN DESDE FLASK (Y RAILWAY)
     ============================================================ */
  const firebaseConfig = {
    apiKey: "{{ firebase_api_key }}",   // CLAVE API INYECTADA DESDE VARIABLES DE ENTORNO
    authDomain: "pzverse-chat.firebaseapp.com",
    projectId: "pzverse-chat",
    storageBucket: "pzverse-chat.firebasestorage.app",
    messagingSenderId: "401483325657",
    appId: "1:401483325657:web:1acf0edcccd6bd9d1e1ec8",
    measurementId: "G-ZF8SLL5JV6"
  };

  // INICIALIZAMOS FIREBASE
  const app = initializeApp(firebaseConfig);
  const messaging = getMessaging(app);

  /* ============================================================
     REGISTRO DEL SERVICE WORKER
     SIN ESTO, NO HAY NOTIFICACIONES PUSH
     ============================================================ */
  if ("serviceWorker" in navigator) {

    // SI EXISTE LA FUNCIÃ“N DEBUG(), MOSTRAMOS MENSAJE EN PANTALLA
    if (typeof debug === "function") debug("INTENTANDO REGISTRAR SERVICE WORKER...");

    // *** RUTA CORRECTA DEL SERVICE WORKER ***
    navigator.serviceWorker.register("/static/firebase-messaging-sw.js")
      .then(reg => {

        console.log("âœ… SERVICE WORKER REGISTRADO:", reg.scope);
        if (typeof debug === "function") debug("SERVICE WORKER REGISTRADO CORRECTAMENTE");

        /* ============================================================
           PEDIR PERMISO DE NOTIFICACIONES AL USUARIO
           ============================================================ */
        return Notification.requestPermission();
      })
      .then(permission => {

        if (permission === "granted") {
          console.log("ðŸ”” PERMISO DE NOTIFICACIONES CONCEDIDO");
          if (typeof debug === "function") debug("PERMISO DE NOTIFICACIONES CONCEDIDO");

          /* ============================================================
             OBTENER TOKEN FCM
             ESTA ES LA CLAVE QUE IDENTIFICA TU MÃ“VIL
             ============================================================ */
          return getToken(messaging, {
            vapidKey: "{{ firebase_vapid_key }}"   // CLAVE VAPID INYECTADA DESDE RAILWAY
          });

        } else {
          console.warn("âš ï¸ PERMISO DE NOTIFICACIONES DENEGADO");
          if (typeof debug === "function") debug("PERMISO DENEGADO POR EL USUARIO");
        }
      })
      .then(currentToken => {

        if (currentToken) {
          console.log("ðŸ“² TOKEN FCM GENERADO:", currentToken);
          if (typeof debug === "function") debug("TOKEN GENERADO: " + currentToken);

          /* ============================================================
             ENVIAR TOKEN AL BACKEND PARA GUARDARLO EN UN ARCHIVO
             ============================================================ */
          fetch("/registrar-token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: currentToken })
          });

          if (typeof debug === "function") debug("TOKEN ENVIADO AL BACKEND");
        }
      })
      .catch(err => {
        console.error("âŒ ERROR EN REGISTRO DE NOTIFICACIONES:", err);
        if (typeof debug === "function") debug("ERROR: " + err);
      });
  }

  /* ============================================================
     NOTIFICACIONES RECIBIDAS EN PRIMER PLANO
     (CUANDO LA WEB ESTÃ ABIERTA)
     ============================================================ */
  onMessage(messaging, (payload) => {
    console.log("ðŸ“© NOTIFICACIÃ“N RECIBIDA EN PRIMER PLANO:", payload);

    if (payload.notification) {
      alert(payload.notification.title + "\n" + payload.notification.body);
    }
  });
</script>



  <!-- ============================================================
       FOOTER
       ============================================================ -->
  <footer class="footer-pz">
    <p>&copy; 2026 PZVERSE â€” Todos los derechos reservados.</p>
    <p>Propiedad de PZVERSE. DiseÃ±o y contenido protegido.</p>
  </footer>

</body>
</html>
